<!DOCTYPE html>
<html>
<head>
	<title>Agora Web Sample</title>
	<link rel="stylesheet" href="vendor/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
	<script src="vendor/jquery.js"></script>
	<script src="vendor/socket.io.js"></script>
	<script src="vendor/adapter.js"></script>
	<script src="AgoraRTCSDK-1.2.5.js"></script>

	<script src="js/clmtrackr.js"></script>
	<script src="js/model_pca_20_svm.js"></script>
	<script src="js/model_pca_20_svm_emotionDetection.js"></script>
	<script src="js/Stats.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="js/emotion_classifier.js"></script>
	<script src="js/emotionmodel.js"></script>
</head>

<body>
<div id="div_device" class="panel panel-default" style="display:none">
	<div class="select">
		<label for="audioSource">Audio source: </label><select id="audioSource"></select>
	</div>
	<div class="select">
		<label for="videoSource">Video source: </label><select id="videoSource"></select>
	</div>
</div>

<div id="div_join" class="panel panel-default" style="display:none">
	<div class="panel-body">
		<button id="join" class="btn btn-primary" onclick="join()">Join</button>
		<button id="leave" class="btn btn-primary" onclick="leave()">Leave</button>
		<button id="publish" class="btn btn-primary" onclick="publish()">Publish</button>
		<button id="unpublish" class="btn btn-primary" onclick="unpublish()">Unpublish</button>
	</div>
</div>

<div id="video-container">
	<div id="agora_local" style="width:400px;height:300px;display:inline-block;"></div>
</div>

<script language="javascript">
	var client, localStream, camera, microphone;

	var socket = io();

	var channelValue = '1001';

	var audioSelect = document.querySelector('select#audioSource');
	var videoSelect = document.querySelector('select#videoSource');

	function join() {
		document.getElementById("join").disabled = true;
		document.getElementById("publish").disabled = true;
		// for dynamic key
		var dynamic_key;
		console.log("Try to get dynamic key");
		var use_https = ('https:' == document.location.protocol);
		if (use_https) {
			var url_str = "https://192.168.0.65:8443/dynamic_key?channelName=" + channelValue;
		} else {
			var url_str = "http://localhost:8080/dynamic_key?channelName=" + channelValue;
		}

		$.ajax({
			url: url_str,
			error: function() {
				console.log("Failed to get dynamic key");
			},
			success: function(response) {
				console.log(response.key);
				dynamic_key = response.key;

				client = AgoraRTC.createRtcClient();
				// for dynamic key
				client.init(dynamic_key, function() {
					console.log("AgoraRTC client initialized");
					client.join(channelValue, undefined, function(uid) {
						socket.emit('join', uid);

						console.log("User " + uid + " join channel successfully");

						camera = videoSource.value;

						microphone = audioSource.value;
						localStream = AgoraRTC.createStream({
							streamID: uid,
							audio: true,
							cameraId: camera,
							microphoneId: microphone,
							video: true,
							screen: false
						});

						localStream.setVideoProfile('480p_2');

						localStream.init(function() {
							console.log("getUserMedia successfully");
							localStream.play('agora_local');

							var emotionCanvas = document.createElement('canvas');
							emotionCanvas.id = 'emotion_canvas';
							emotionCanvas.width = 405;
							emotionCanvas.height = 303;
							document.querySelector('#agora_local').appendChild(emotionCanvas);





							client.publish(localStream, function(err) {
								console.log("Publish local stream error: " + err);
							});

							client.on('stream-published', function(evt) {
								console.log("Publish local stream successfully");
							});

						}, function(err) {
							console.log("getUserMedia failed", err);
						});

					}, function(err) {
						console.log("Join channel failed", err);
					});

				}, function(err) {
					console.log("AgoraRTC client init failed", err);
				});

				client.on('stream-added', function(evt) {
					var stream = evt.stream;
					console.log("New stream added: " + stream.getId());
					console.log("Subscribe ", stream);
					client.subscribe(stream, function(err) {
						console.log("Subscribe stream failed", err);
					});
				});

				client.on('stream-subscribed', function(evt) {
					var stream = evt.stream;
					console.log("Subscribe remote stream successfully: " + stream.getId());
					if ($('div#video-container #agora_remote' + stream.getId()).length === 0) {
						var container = document.createElement("div");
						container.id = 'agora_container' + stream.getId();
						document.querySelector('#video-container').appendChild(container);
						$(container).append('<div id="agora_remote' + stream.getId() + '" style="width:405px;height:303px;display:inline-block;"></div>');
						$(container).append('<canvas id="drawCanvas' + stream.getId() + '" width='+405+' height='+303+'"></canvas>');
						$(container).append('<div id="emotion_container"> <div id="emotion_icons"> <img class="emotion_icon" id="icon1" src="./media/icon_angry.png"> <img class="emotion_icon" id="icon2" src="./media/icon_sad.png"> <img class="emotion_icon" id="icon3" src="./media/icon_surprised.png"> <img class="emotion_icon" id="icon4" src="./media/icon_happy.png"> </div> <div id="emotion_chart"></div>')};
						stream.play('agora_remote' + stream.getId());

						var canvasInput = document.querySelector('#drawCanvas' + + stream.getId() +'');
						var videoInput = document.querySelector('#agora_remote' + + stream.getId() + ' video');
						videoInput.width = 400;
						videoInput.height = 300;

						var ctracker = new clm.tracker();
						ctracker.init(pModel);
						ctracker.start(videoInput);

					function positionLoop() {
						requestAnimationFrame(positionLoop);
						var positions = ctracker.getCurrentPosition();
						// positions = [[x_0, y_0], [x_1,y_1], ... ]
						// do something with the positions ...
					}
					positionLoop();

					var cc = canvasInput.getContext('2d');
					function drawLoop() {
						requestAnimationFrame(drawLoop);
						cc.clearRect(0, 0, canvasInput.width, canvasInput.height);
						if (ctracker.getCurrentPosition()) {
						ctracker.draw(canvasInput);
						}
						var cp = ctracker.getCurrentParameters();

						var er = ec.meanPredict(cp);
						if (er) {
							updateData(er);
							for (var i = 0;i < er.length;i++) {
								if (er[i].value > 0.4) {
									document.getElementById('icon'+(i+1)).style.visibility = 'visible';
								} else {
									document.getElementById('icon'+(i+1)).style.visibility = 'hidden';
								}
							}
						}
					}

// *******************************d3 code

var ec = new emotionClassifier();
				ec.init(emotionModel);
				var emotionData = ec.getBlank();

				/************ d3 code for barchart *****************/

				var margin = {top : 20, right : 20, bottom : 10, left : 40},
					width = 400 - margin.left - margin.right,
					height = 100 - margin.top - margin.bottom;

				var barWidth = 30;

				var formatPercent = d3.format(".0%");

				var x = d3.scale.linear()
					.domain([0, ec.getEmotions().length]).range([margin.left, width+margin.left]);

				var y = d3.scale.linear()
					.domain([0,1]).range([0, height]);

				var svg = d3.select("#emotion_chart").append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)

				svg.selectAll("rect").
				  data(emotionData).
				  enter().
				  append("svg:rect").
				  attr("x", function(datum, index) { return x(index); }).
				  attr("y", function(datum) { return height - y(datum.value); }).
				  attr("height", function(datum) { return y(datum.value); }).
				  attr("width", barWidth).
				  attr("fill", "#2d578b");

				svg.selectAll("text.labels").
				  data(emotionData).
				  enter().
				  append("svg:text").
				  attr("x", function(datum, index) { return x(index) + barWidth; }).
				  attr("y", function(datum) { return height - y(datum.value); }).
				  attr("dx", -barWidth/2).
				  attr("dy", "1.2em").
				  attr("text-anchor", "middle").
				  text(function(datum) { return datum.value;}).
				  attr("fill", "white").
				  attr("class", "labels");

				svg.selectAll("text.yAxis").
				  data(emotionData).
				  enter().append("svg:text").
				  attr("x", function(datum, index) { return x(index) + barWidth; }).
				  attr("y", height).
				  attr("dx", -barWidth/2).
				  attr("text-anchor", "middle").
				  attr("style", "font-size: 12").
				  text(function(datum) { return datum.emotion;}).
				  attr("transform", "translate(0, 18)").
				  attr("class", "yAxis");

				function updateData(data) {
					// update
					var rects = svg.selectAll("rect")
						.data(data)
						.attr("y", function(datum) { return height - y(datum.value); })
						.attr("height", function(datum) { return y(datum.value); });
					var texts = svg.selectAll("text.labels")
						.data(data)
						.attr("y", function(datum) { return height - y(datum.value); })
						.text(function(datum) { return datum.value.toFixed(1);});

					// enter
					rects.enter().append("svg:rect");
					texts.enter().append("svg:text");

					// exit
					rects.exit().remove();
					texts.exit().remove();
				}

				// end of d3 code *******************



					drawLoop();
				});

				client.on('stream-removed', function(evt) {
					var stream = evt.stream;
					stream.stop();
					console.log("Remote stream is removed " + stream.getId());
				});

				client.on('peer-leave', function(evt) {
					var stream = evt.stream;

					socket.emit('leave', evt.uid);

					stream.stop();
					document.querySelector("#video-container").removeChild(document.querySelector('#agora_container' + + evt.uid + ''));
					console.log(evt.uid + " leaved from this channel");
				});
			}
		});
	}

	join();

	function leave() {
		document.getElementById("leave").disabled = true;
		client.leave(function() {
			console.log("Leavel channel successfully");
		}, function(err) {
			console.log("Leave channel failed");
		});
	}

	function publish() {
		document.getElementById("publish").disabled = true;
		client.publish(localStream, function(err) {
			console.log("Publish local stream error: " + err);
		});
	}

	function unpublish() {
		document.getElementById("publish").disabled = false;
		document.getElementById("unpublish").disabled = true;
		client.unpublish(localStream, function(err) {
			console.log("Unpublish local stream failed" + err);
		});
	}

	function getDevices() {
		AgoraRTC.getDevices(function(devices) {
			for (var i = 0; i !== devices.length; ++i) {
				var device = devices[i];
				var option = document.createElement('option');
				option.value = device.deviceId;
				if (device.kind === 'audioinput') {
					option.text = device.label || 'microphone ' + (audioSelect.length + 1);
					audioSelect.appendChild(option);
				} else if (device.kind === 'videoinput') {
					option.text = device.label || 'camera ' + (videoSelect.length + 1);
					videoSelect.appendChild(option);
				} else {
					console.log('Some other kind of source/device: ', device);
				}
			}
		});
	}

	//audioSelect.onchange = getDevices;
	//videoSelect.onchange = getDevices;

	getDevices();
</script>
</body>
</html>
