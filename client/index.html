<!DOCTYPE html>
<html>
<head>
	<title>Agora Web Sample</title>
	<link rel="stylesheet" href="vendor/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
	<script src="vendor/jquery.js"></script>
	<script src="vendor/socket.io.js"></script>
	<script src="vendor/adapter.js"></script>
	<script src="AgoraRTCSDK-1.2.5.js"></script>

	<script src="js/clmtrackr.js"></script>
	<script src="js/model_pca_20_svm.js"></script>
	<script src="js/model_pca_20_svm_emotionDetection.js"></script>
	<script src="js/Stats.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="js/emotion_classifier.js"></script>
	<script src="js/emotionmodel.js"></script>

	<script src="js/dat.gui.min.js"></script>
	<script src="js/utils.js"></script>
	<script src="js/clmtrackr.js"></script>
	<script src="js/face_deformer.js"></script>
	<script src="js/poisson_new.js"></script>
</head>

<body>

<div class="login_page">
	<div class="user_name_container">
		<label for="username">Your Name: </label>
		<input type="text" id="username" name="username"/>
	</div>
	<div class="mask_selector_container">
		<span class="mask"></span>
		<span class="mask"></span>
		<span class="mask"></span>
		<span class="mask"></span>
		<span class="mask"></span>
	</div>
	<button class="start_button">Start!</button>
</div>

<div id="div_device" class="panel panel-default" style="display:none">
	<div class="select">
		<label for="audioSource">Audio source: </label><select id="audioSource"></select>
	</div>
	<div class="select">
		<label for="videoSource">Video source: </label><select id="videoSource"></select>
	</div>
</div>

<div id="div_join" class="panel panel-default" style="display:none">
	<div class="panel-body">
		<button id="join" class="btn btn-primary" onclick="join()">Join</button>
		<button id="leave" class="btn btn-primary" onclick="leave()">Leave</button>
		<button id="publish" class="btn btn-primary" onclick="publish()">Publish</button>
		<button id="unpublish" class="btn btn-primary" onclick="unpublish()">Unpublish</button>
	</div>
</div>

<div id="video-container">
	<div class="left-part">
		<div id="agora_local" style="width:400px;height:300px;display:inline-block;"></div>
	</div><div class="right-part"></div>
</div>

<img id="average" class="masks" src="./assets/average.bmp"></img>
<img id="monalisa" class="masks" src="./assets/joconde.jpg"></img>
<img id="ironman" class="masks" src="./assets/ironman.jpg"></img>

<script language="javascript">
	var client, localStream, camera, microphone;

	var socket = io();

	var channelValue = '1001';

	var audioSelect = document.querySelector('select#audioSource');
	var videoSelect = document.querySelector('select#videoSource');

	function join() {
		document.getElementById("join").disabled = true;
		document.getElementById("publish").disabled = true;
		// for dynamic key
		var dynamic_key;
		console.log("Try to get dynamic key");
		var use_https = ('https:' == document.location.protocol);
		if (use_https) {
			var url_str = "https://192.168.0.65:8443/dynamic_key?channelName=" + channelValue;
		} else {
			var url_str = "http://localhost:8080/dynamic_key?channelName=" + channelValue;
		}

		$.ajax({
			url: url_str,
			error: function() {
				console.log("Failed to get dynamic key");
			},
			success: function(response) {
				console.log(response.key);
				dynamic_key = response.key;

				client = AgoraRTC.createRtcClient();
				// for dynamic key
				client.init(dynamic_key, function() {
					console.log("AgoraRTC client initialized");
					client.join(channelValue, undefined, function(uid) {
						socket.emit('join', uid);

						console.log("User " + uid + " join channel successfully");

						camera = videoSource.value;

						microphone = audioSource.value;
						localStream = AgoraRTC.createStream({
							streamID: uid,
							audio: true,
							cameraId: camera,
							microphoneId: microphone,
							video: true,
							screen: false
						});

						localStream.setVideoProfile('480p_2');

						localStream.init(function() {
							console.log("getUserMedia successfully");
							localStream.play('agora_local');

							var subsCanvas = document.createElement('canvas');
							subsCanvas.id = 'webgl';
							subsCanvas.width = 405;
							subsCanvas.height = 303;
							document.querySelector('#agora_local').appendChild(subsCanvas);
							/*********** Code for face substitution *********/

							var animationRequest;
							var positions;
							document.getElementById('selectmask').addEventListener('change', updateMask, false);

							function updateMask(el) {
								currentMask = parseInt(el.target.value, 10);
								var positions = ctrack.getCurrentPosition(vid);
								if (positions) {
									switchMasks(positions);
								}
							}

							function startVideo() {
								// start video
								vid.play();
								// start tracking
								ctrack.start(vid);
								// start drawing face grid
								drawGridLoop();
							}

							var fd = new faceDeformer();
							fd.init(document.getElementById('webgl'));
							var wc1 = document.getElementById('webgl').getContext('webgl') || document.getElementById('webgl').getContext('experimental-webgl')
							wc1.clearColor(0,0,0,0);

							var fd2 = new faceDeformer();
							fd2.init(document.getElementById('webgl2'));
							var wc2 = document.getElementById('webgl2').getContext('webgl') || document.getElementById('webgl2').getContext('experimental-webgl')
							wc2.clearColor(0,0,0,0);

							var masks = {
												"average" : [[26.416248681267973, 69.287261104729708], [24.481184011083002, 109.1589911732479], [29.947934496257105, 148.57677024306452], [40.60811914491601, 185.45355598250219], [58.738097832656997, 216.6373204614957], [81.913770252207783, 237.8126294428132], [109.98606755351314, 257.32753166261085], [146.73017889094805, 264.20702756677571], [176.39901111159972, 257.35535351543069], [205.55603543434725, 238.34973455076488], [230.2355979713912, 210.41080746713624], [246.42195156813636, 177.61588628182037], [256.27933737115922, 136.43585286772219], [257.59862842161016, 101.26962757170907], [254.73574762861881, 63.296736154716768], [231.99351427704215, 39.831219799322724], [211.74886735135794, 29.357561061634286], [185.76946624427666, 32.692120457915841], [164.22794828410485, 39.057255405015212], [46.913242738637145, 44.216922272932521], [67.285057768685547, 32.598869110365555], [94.508786161963428, 34.746232646423401], [114.82786184548833, 39.533999746268229], [65.935953298843103, 69.239210402794683], [84.787589310043472, 58.321913189471772], [107.1385272571674, 69.051184056088701], [84.265668561805413, 74.447322016970119], [86.02844527485162, 66.55652441349649], [215.49276321482714, 66.02198446506911], [194.41225043477402, 56.580567518322354], [173.10349613934835, 67.506651798297085], [193.89655333472706, 70.825843235112714], [194.97190332017632, 64.213669799586413], [140.21544525228168, 50.532541524375866], [115.12210668936649, 112.86816444161286], [106.91733219119472, 128.11159519340237], [116.15332322527513, 140.65598165170533], [143.55679637420633, 142.73810254422773], [167.66884888729888, 137.95626733353842], [177.01070972200523, 125.94118566337217], [167.72534960722709, 111.07005102224311], [141.09391638922847, 89.711267100602939], [125.01121871692496, 134.01776882451776], [158.83114482022663, 132.84441173561655], [98.530013119819074, 181.49830160240677], [114.57531577249451, 172.88988327185314], [130.69321885263625, 168.51487947819879], [140.91575863744487, 170.62230018050224], [150.99524791299294, 168.10359663640762], [166.86355823591094, 171.92886610080987], [186.52748819945225, 179.57395522560827], [172.54811810821857, 193.62104452332397], [161.34374255744575, 203.55652478332667], [143.04951921782722, 206.98995295806665], [122.71362572694508, 202.88542194975037], [109.36831831524565, 194.44995485842813], [121.30529318118789, 187.44959256875671], [141.15688782807084, 190.12567632986739], [161.94486681509784, 187.9983882494468], [161.78346166803792, 178.31913412814549], [141.60005262336557, 178.73596022750081], [121.19014424606702, 179.74550271876572], [142.06000674291235, 125.94776468631429], [74.161858259749053, 61.982126979168953], [99.563603953011338, 61.887044688264439], [97.202478466508737, 72.650836394381287], [74.199064214851546, 73.344884154018885], [204.65317864223729, 59.203268807746532], [180.45823699179422, 60.544222235843449], [183.20168844348697, 70.667846856664895], [204.99820389502713, 70.525790218266522]]
											}

							var currentMask = 0;

										// canvas for copying the warped face to
										var newcanvas = document.createElement('CANVAS');
										newcanvas.width = vid.width;
										newcanvas.height = vid.height;
										// canvas for copying videoframes to
										var videocanvas = document.createElement('CANVAS');
										videocanvas.width = vid.width;
										videocanvas.height = vid.height;
										// canvas for masking
										var maskcanvas = document.createElement('CANVAS');
										maskcanvas.width = vid.width;
										maskcanvas.height = vid.height;

										// create canvases for all the faces
										var imageCanvases = {};
										var imageCount = 0;
										loadMask = function(index){
											var mask = new Image();
											mask.onload = function(obj){
												var elementId = images[index].id;

												// copy the images to canvases
												imagecanvas = document.createElement('CANVAS');
												imagecanvas.width = obj.target.width;
												imagecanvas.height = obj.target.height;
												imagecanvas.getContext('2d').drawImage(obj.target,0,0);
												imageCanvases[elementId] = imagecanvas;

												imageCount += 1;
												if (imageCount == images.length) {
													imagesReady = true;
												}
												enablestart();
											}
						              		mask.src = images[index].path;
										}
										//load masks
										for (var i = 0;i < images.length;i++) {
											loadMask(i);
										}

										var extended_vertices = [
										  [0,71,72,0],
										  [0,72,1,0],
										  [1,72,73,1],
										  [1,73,2,1],
										  [2,73,74,2],
										  [2,74,3,2],
										  [3,74,75,3],
										  [3,75,4,3],
										  [4,75,76,4],
										  [4,76,5,4],
										  [5,76,77,5],
										  [5,77,6,5],
										  [6,77,78,6],
										  [6,78,7,6],
										  [7,78,79,7],
										  [7,79,8,7],
										  [8,79,80,8],
										  [8,80,9,8],
										  [9,80,81,9],
										  [9,81,10,9],
										  [10,81,82,10],
										  [10,82,11,10],
										  [11,82,83,11],
										  [11,83,12,11],
										  [12,83,84,12],
										  [12,84,13,12],
										  [13,84,85,13],
										  [13,85,14,13],
										  [14,85,86,14],
										  [14,86,15,14],
										  [15,86,87,15],
										  [15,87,16,15],
										  [16,87,88,16],
										  [16,88,17,16],
										  [17,88,89,17],
										  [17,89,18,17],
										  [18,89,90,18],
										  [18,90,22,18],
										  [22,90,21,22],
										  [21,90,91,21],
										  [21,20,91,21],
										  [20,91,92,20],
										  [20,92,19,20],
										  [19,92,93,19],
										  [19,93,71,19],
										  [19,0,71,19],
										  [44,61,56,44],
										  [60,61,56,60],
										  [60,56,57,60],
										  [60,59,57,60],
										  [58,59,57,58],
										  [58,59,50,58]
										];

										function drawGridLoop() {
											// get position of face
											positions = ctrack.getCurrentPosition(vid);

											overlayCC.clearRect(0, 0, 500, 375);
											if (positions) {
												// draw current grid
												ctrack.draw(overlay);
											}
											// check whether mask has converged
											var pn = ctrack.getConvergence();
											if (pn < 0.4) {
												switchMasks(positions);
											} else {
												requestAnimFrame(drawGridLoop);
											}
										}

										function switchMasks(pos) {
											videocanvas.getContext('2d').drawImage(vid,0,0,videocanvas.width,videocanvas.height);

											// we need to extend the positions with new estimated points in order to get pixels immediately outside mask
											var newMaskPos = masks[images[currentMask].id].slice(0);
											var newFacePos = pos.slice(0);
											var extInd = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,22,21,20,19];
											var newp;
											for (var i = 0;i < 23;i++) {
												newp = [];
												newp[0] = (newMaskPos[extInd[i]][0]*1.3) - (newMaskPos[62][0]*0.3);// short for ((newMaskPos[extInd[i]][0]-newMaskPos[62][0])*1.1)+newMaskPos[62][0]
												newp[1] = (newMaskPos[extInd[i]][1]*1.3) - (newMaskPos[62][1]*0.3);
												newMaskPos.push(newp);
												newp = [];
												newp[0] = (newFacePos[extInd[i]][0]*1.3) - (newFacePos[62][0]*0.3);
												newp[1] = (newFacePos[extInd[i]][1]*1.3) - (newFacePos[62][1]*0.3);
												newFacePos.push(newp);
											}
											// also need to make new vertices incorporating area outside mask
											var newVertices = pModel.path.vertices.concat(extended_vertices);

											// deform the mask we want to use to face form
											fd2.load(imageCanvases[images[currentMask].id], newMaskPos, pModel, newVertices);
											fd2.draw(newFacePos);
											// and copy onto new canvas
											newcanvas.getContext('2d').drawImage(document.getElementById('webgl2'),0,0);

											// create masking
											var tempcoords = positions.slice(0,18);
											tempcoords.push(positions[21]);
											tempcoords.push(positions[20]);
											tempcoords.push(positions[19]);
											createMasking(maskcanvas, tempcoords);
											// do poisson blending
											Poisson.load(newcanvas, videocanvas, maskcanvas, function() {
												var result = Poisson.blend(30, 0, 0);
												// render to canvas
												newcanvas.getContext('2d').putImageData(result, 0, 0);
												// get mask

												var maskname = Object.keys(masks)[currentMask];
												fd.load(newcanvas, pos, pModel);
												requestAnimFrame(drawMaskLoop);
											});
										}

										function drawMaskLoop() {
											// get position of face
											positions = ctrack.getCurrentPosition();

											/*for (var i = 0;i < positions.length;i++) {
												positions[i][1] += 1;
											}*/

											overlayCC.clearRect(0, 0, 400, 300);
											if (positions) {
												// draw mask on top of face
												fd.draw(positions);
											}
											animationRequest = requestAnimFrame(drawMaskLoop);
										}

										function createMasking(canvas, modelpoints) {
											// fill canvas with black
											var cc = canvas.getContext('2d');
											cc.fillStyle="#000000";
											cc.fillRect(0,0,canvas.width, canvas.height);
											cc.beginPath();
											cc.moveTo(modelpoints[0][0], modelpoints[0][1]);
											for (var i = 1;i < modelpoints.length;i++) {
												cc.lineTo(modelpoints[i][0], modelpoints[i][1]);
											}
											cc.lineTo(modelpoints[0][0], modelpoints[0][1]);
											cc.closePath();
											cc.fillStyle="#ffffff";
											cc.fill();
										}

							client.publish(localStream, function(err) {
								console.log("Publish local stream error: " + err);
							});

							client.on('stream-published', function(evt) {
								console.log("Publish local stream successfully");
							});

						}, function(err) {
							console.log("getUserMedia failed", err);
						});

					}, function(err) {
						console.log("Join channel failed", err);
					});

				}, function(err) {
					console.log("AgoraRTC client init failed", err);
				});

				client.on('stream-added', function(evt) {
					var stream = evt.stream;
					console.log("New stream added: " + stream.getId());
					console.log("Subscribe ", stream);
					client.subscribe(stream, function(err) {
						console.log("Subscribe stream failed", err);
					});
				});

				/* ===SUBSCRIBED===  */
				client.on('stream-subscribed', function(evt) {
					var stream = evt.stream;
					console.log("Subscribe remote stream successfully: " + stream.getId());
					if ($('div#video-container #agora_remote' + stream.getId()).length === 0) {
						var container = document.createElement("div");
						container.id = 'agora_container' + stream.getId();
						document.querySelector('#video-container .right-part').appendChild(container);
						$(container).append('<div id="agora_remote' + stream.getId() + '" style="width:405px;height:303px;display:inline-block;"></div>');
						$(container).append('<canvas id="drawCanvas' + stream.getId() + '" width=' + 405 + ' height=' + 303 + '"></canvas>');
						$(container).append('<canvas id="overlay' + stream.getId() + '" width=' + 405 + ' height=' + 303 + '"></canvas>');
						$(container).append('<canvas id="webgl' + stream.getId() + '" width=' + 405 + ' height=' + 303 + '"></canvas>');
						$(container).append('<div id="emotion_container"> <div id="emotion_icons"> <img class="emotion_icon" id="icon1" src="./media/icon_angry.png"> <img class="emotion_icon" id="icon2" src="./media/icon_sad.png"> <img class="emotion_icon" id="icon3" src="./media/icon_surprised.png"> <img class="emotion_icon" id="icon4" src="./media/icon_happy.png"> </div> <div id="emotion_chart"></div>')
					}

					stream.play('agora_remote' + stream.getId());

					var canvasInput = document.querySelector('#drawCanvas' + +stream.getId() + '');
					var videoInput = document.querySelector('#agora_remote' + +stream.getId() + ' video');
					videoInput.width = 400;
					videoInput.height = 300;

					var ctracker = new clm.tracker();
					ctracker.init(pModel);
					ctracker.start(videoInput);

					var cc = canvasInput.getContext('2d');


					var vid = document.getElementById('agora_remote' + stream.getId());
					var overlay = document.getElementById('overlay' + stream.getId());
					var overlayCC = overlay.getContext('2d');

					var webGLContext;
					var webGLTestCanvas = document.createElement('canvas');
					if (window.WebGLRenderingContext) {
						webGLContext = webGLTestCanvas.getContext('webgl' + stream.getId()) || webGLTestCanvas.getContext('experimental-webgl');
						if (!webGLContext || !webGLContext.getExtension('OES_texture_float')) {
							webGLContext = null;
						}
					}
					if (webGLContext == null) {
						alert("Your browser does not seem to support WebGL. Unfortunately this face mask example depends on WebGL, so you'll have to try it in another browser. :(");
					}

					navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
					window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

					function updateMask(el) {
						currentMask = parseInt(el.target.value, 10);
						switchMasks();
					}
					function startVideo() {
						ctracker.start(vid);
						drawGridLoop();
					}

					startVideo();

					var positions;
					var fd = new faceDeformer();
					fd.init(document.getElementById('webgl' + stream.getId()));

					var masks = {
						"average" : [[121.92799191984679,184.19216240419755],[118.74113263254269,253.7017373484083],[128.07732840700828,314.0651648786312],[145.50341586402052,377.3404382903117],[175.0470179047746,428.3720278198884],[216.26268310246033,469.2344402538887],[267.42588166495466,502.128073946532],[323.6864139765614,512.5053811316307],[381.1889691089136,499.48530971536445],[429.71357990120225,463.4214900408549],[467.1292936657478,421.537754329594],[493.2308725208873,370.6466670145585],[507.3945907183312,305.3965374123],[514.1098885852615,238.51000761747102],[507.2009944162471,174.7364492942625],[465.59705810723074,136.75665747531139],[432.10874975324265,125],[384.15174446143584,125],[351.54488594535763,135.22963355336668],[162.16177451030518,144.72103952617107],[194.70376235949394,126],[241,130],[277.5198647210173,137.82992220884094],[192.5627380181407,182.35373455399292],[225.1658086004223,166.85817167285668],[262.9021389237093,184.72604899079232],[224.82421319031323,193.62679469584918],[224.9386274222809,179.73191446260716],[443.75218061508883,177.1556294105885],[407.36102478935464,162.1785032964798],[367.3426762945685,181.37362678808685],[405.2498567443763,188.75927101523848],[404.863153412407,173.65270066194788],[314, 170],[277.2539320006613,252.0592473714927],[258.790607031229,284.0832945003201],[276.64778558874696,304.54255347445314],[317.4772090972725,307.7859653833357],[364.4959193923387,299.6561959465791],[377.27275089177823,279.043842539653],[357.1140334647449,250.14961061471956],[324,222],[296.770695143374,295.6331974142146],[350.24114846328195,290.942330984987],[248.8532880314441,372.38004806995957],[272.1557077756945,356.35352520595814],[302.9902196911147,350.59821534914704],[323.11457426149127,353.0358352022737],[338.3055779254553,347.5427982113969],[366.49269601972713,353.1538257295358],[392.63652105652415,368.4911974180641],[375.0778975047938,391.4413420753004],[352.32935954043757,405.19247889714825],[320.19499419206926,411.930992226806],[288.9192573286629,407.35752671668797],[267.61253113280924,394.527019223827],[286.6817714614754,382.82667526139215],[320.16223074694074,385.86502934549657],[359.1212544588326,380.7487964985724],[361.7270998810554,365.15603335898066],[322.91210334135167,367.2901736762333],[280.7920218316411,368.2798825278876],[320.66814785515174,277.11007275979364],[206.36606604411398,171.6086547538323],[247.5375468161923,170.29657636660522],[246.36866333618227,191.67729410789994],[205.19888043799355,189.99033691329964],[429.0603263358775,166.1691180598579],[386.8504393293843,166.2774220754911],[384.7938981921405,186.5701136634426],[426.9983448269614,184.45786533091854]],
						"monalisa" : [[266.539778613571,254.84378898872825],[266.3039097561577,285.302233189556],[271.19357329466345,316.3538789507933],[278.7139543521674,345.15573844972926],[293.15712497356776,368.9809024015706],[312.64193974141324,389.09850232246515],[322.13343587641253,398.3663601209212],[336.9858985066435,401.49456958745145],[356.87519225850986,398.5376499254816],[382.97232156668036,391.79752653535775],[421.61286401088506,373.50434543677886],[448.74322775690695,344.0259953810623],[464.77440099078314,310.71915538180275],[468.2775933241595,272.2241198406615],[466.74514645738424,247.20492682906303],[415.26964981149064,225.8370550250565],[390.13712322351404,222],[361.92175039938184,220.2582273389706],[342.2734356138508,232.04834635926073],[267.7624903928149,236.00873885152805],[280.88607721372824,229],[303.9033677258633,228],[316.6965360192193,234.20369314639848],[281.57998031880885,254.77971856631495],[298.953459306752,246.21641370334032],[315.75345517431316,254.4516165242651],[296.6631361379687,258.36486568494297],[301.63327656416925,252.0239926097512],[398.27491865673994,249.8954346966754],[380.22403819342355,243.83584281695727],[357.98660716766716,253.53119540181672],[378.25469629277825,255.99515336941278],[382.6139465907322,249.6433274231842],[328,253],[314.73794539936216,301.757722929817],[309.85213116736014,314.6797549304112],[313.1507370768973,321.4994076914073],[325.20473159190635,327.87953636258146],[350.1231795924951,324.5425216268138],[358.3783946629097,316.6717252774034],[352.7986254362873,299.5519517987678],[326,282],[314.75674487301336,318.32005216616164],[343.0322275619273,319.2819917007706],[307.87514392633693,346.0346979532304],[316.68926117981914,342.91320569661593],[321.7320399187087,341.45780089974846],[327.8558316510405,343.56649844038935],[336.18423231506125,341.74737597014604],[351.00603891713007,342.2560527375472],[367.88222498993025,344.3660717427479],[357.305053617142,354.4583428810625],[343.5761668856892,358.8848818975423],[328.82001419900075,359.1051832365163],[320.36190636746045,358.71759346010083],[312.61714975606304,353.5625007817836],[318.4988566294063,348.1744254793423],[328.6406599928464,349.73460503451736],[350.2480353796336,349.6831133201238],[349.5754234743516,349.5362145583936],[329.32557946752445,349.67345155068153],[318.2253756678819,347.9222277142419],[324.4964277572599,315.63122813643895],[288.26630901657126,248.99890899333045],[309.3536455351319,248.83485523505226],[307.7075352919804,256.40978560947974],[288.62032608071166,258.5736833679789],[390.2498028902113,244.8663932568382],[368.1047796233772,247.18427292360775],[368.62079313091925,255.76448975973483],[390.7655312307384,254.4464699123733]],
						"ironman" : [[54.132994582809886,330.2447406482356],[53.94983737338171,411.6786947731232],[59.50117090734213,485.54290769879117],[69.05631570910228,577.6685769791815],[80.73400747239302,669.2047081882876],[156.52267192878207,721.5706883991684],[224.03761978834723,739.1269072358452],[301.4803537679236,738.2366874355024],[373.4196207112528,736.6185556997145],[445.4373067968218,720.1452812831552],[517.3056114476371,670.5474614197833],[531.7799053755264,574.1779931382804],[540.681172219442,487.967223266098],[542.4032150608897,399.64595333584305],[541.5099369565868,318.2177239885218],[484.00763535360403,311.3318445452918],[436.57616449858205,326.12885038303966],[386.214847801106,333.2043197182652],[344.39911403378784,336.7706741289662],[115.84864343665006,313.35525243241443],[152.60840318917894,322.7145050535586],[201.39783835228144,332.29526724516336],[249.58724826191298,336.53976562323317],[116.48023640991207,348.8633768136441],[167.9642886955806,350.9962302246727],[231.6749647028165,359.48349174177827],[168.11831577303042,375.4865728177492],[170.07462103025938,361.76575290725043],[480.7831200700384,348.57719399476593],[423.78106882269736,353.08381522791285],[369.5853199174605,360.3348770905004],[429.2517105029677,374.978498189726],[428.4672557696136,361.0310278167258],[298,363],[253.70821429640165,456.1515630753871],[232.81854206254127,493.52915431030885],[250.27449264190767,519.2760705851281],[294.9905749783811,522.6580485667231],[340.00710866420684,520.8077271147647],[357.28424845402884,493.1349774295837],[336.03221275387335,457.7253897416814],[296,407],[270.69780042635847,507.2277260957476],[320.8265507066314,506.90809731554305],[219.49207600124322,603.6108989555861],[236.4148918469843,589.8509195222699],[267.0123175575189,590.2653879517876],[302.37639394449644,589.4456339021824],[337.18338067155105,591.0755705685021],[366.9537080661368,591.1696362146871],[383.17030058050824,601.5027761622135],[366.07822563380967,614.8268645173376],[336.20759244137867,615.427540755917],[304.12597029775543,615.4777558918809],[270.01910167830954,615.9331065732697],[240.4271869365151,614.9063722445486],[255.5183417994636,603.9175341052295],[302.81892822034536,605.4895650711086],[350.74058301633727,604.2225054756758],[350.6655959742464,603.528118265738],[303.78446463916174,604.3090513544694],[256.409865954666,603.8790201634539],[298.25175247557996,482.7822436696597],[141.22182216936852,346.4270057321846],[206.31948949078424,356.7387529836485],[202.39427275621864,368.9872676086593],[136.2964448024117,368.67555898584044],[454.78000220898934,348.3276075895992],[398.6821272555564,355.2080431875895],[398.9194910642594,369.6579535284187],[466.01878775359233,368.7792910743897]],
					};
					var currentMask = 1;
					var animationRequest;

					function drawGridLoop() {
						// get position of face
						positions = ctracker.getCurrentPosition(vid);
						overlayCC.clearRect(0, 0, 500, 375);
						if (positions) {
							// draw current grid
							ctracker.draw(overlay);
						}
						// check whether mask has converged
						var pn = ctracker.getConvergence();
						if (pn < 0.4) {
							switchMasks();
							requestAnimFrame(drawMaskLoop);
						} else {
							requestAnimFrame(drawGridLoop);
						}
					}

					function switchMasks() {
						var maskname = Object.keys(masks)[currentMask];
						fd.load(document.getElementById(maskname), masks[maskname], pModel);
					}

					function drawMaskLoop() {
						// get position of face
						positions = ctracker.getCurrentPosition();
						overlayCC.clearRect(0, 0, 400, 300);
						if (positions) {
							// draw mask on top of face
							fd.draw(positions);
						}
						animationRequest = requestAnimFrame(drawMaskLoop);
					}



					function drawLoop() {
						requestAnimationFrame(drawLoop);
						cc.clearRect(0, 0, canvasInput.width, canvasInput.height);
//						if (ctracker.getCurrentPosition()) {
//							ctracker.draw(canvasInput);
//						}
						var cp = ctracker.getCurrentParameters();

						var er = ec.meanPredict(cp);
						if (er) {
							updateData(er);
							for (var i = 0; i < er.length; i++) {
								if (document.querySelector('#agora_container' + stream.getId() + ' #icon' + (i + 1))) {
									if (er[i].value > 0.4) {
										document.querySelector('#agora_container' + stream.getId() + ' #icon' + (i + 1)).style.visibility = 'visible';
									} else {
										document.querySelector('#agora_container' + stream.getId() + ' #icon' + (i + 1)).style.visibility = 'hidden';
									}
								}
							}
						}
					}

// *******************************d3 code

					var ec = new emotionClassifier();
					ec.init(emotionModel);
					var emotionData = ec.getBlank();

					/************ d3 code for barchart *****************/

					var margin = {top: 20, right: 20, bottom: 10, left: 40},
						width = 400 - margin.left - margin.right,
						height = 100 - margin.top - margin.bottom;

					var barWidth = 30;

					var x = d3.scale.linear()
						.domain([0, ec.getEmotions().length]).range([margin.left, width + margin.left]);

					var y = d3.scale.linear()
						.domain([0, 1]).range([0, height]);

					var svg = d3.select("#agora_container" + stream.getId() + " #emotion_chart").append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom);

					svg.selectAll("rect").data(emotionData).enter().append("svg:rect").attr("x", function(datum, index) {
						return x(index);
					}).attr("y", function(datum) {
						return height - y(datum.value);
					}).attr("height", function(datum) {
						return y(datum.value);
					}).attr("width", barWidth).attr("fill", "#2d578b");

					svg.selectAll("text.labels").data(emotionData).enter().append("svg:text").attr("x", function(datum, index) {
						return x(index) + barWidth;
					}).attr("y", function(datum) {
						return height - y(datum.value);
					}).attr("dx", -barWidth / 2).attr("dy", "1.2em").attr("text-anchor", "middle").text(function(datum) {
						return datum.value;
					}).attr("fill", "white").attr("class", "labels");

					svg.selectAll("text.yAxis").data(emotionData).enter().append("svg:text").attr("x", function(datum, index) {
						return x(index) + barWidth;
					}).attr("y", height).attr("dx", -barWidth / 2).attr("text-anchor", "middle").attr("style", "font-size: 12").text(function(datum) {
						return datum.emotion;
					}).attr("transform", "translate(0, 18)").attr("class", "yAxis");

					function updateData(data) {
						// update
						var rects = svg.selectAll("rect")
							.data(data)
							.attr("y", function(datum) {
								return height - y(datum.value);
							})
							.attr("height", function(datum) {
								return y(datum.value);
							});
						var texts = svg.selectAll("text.labels")
							.data(data)
							.attr("y", function(datum) {
								return height - y(datum.value);
							})
							.text(function(datum) {
								return datum.value.toFixed(1);
							});

						// enter
						rects.enter().append("svg:rect");
						texts.enter().append("svg:text");

						// exit
						rects.exit().remove();
						texts.exit().remove();
					}

					// end of d3 code *******************

					drawLoop();
				});

				client.on('stream-removed', function(evt) {
					var stream = evt.stream;
					stream.stop();
					console.log("Remote stream is removed " + stream.getId());
				});

				client.on('peer-leave', function(evt) {
					var stream = evt.stream;

					socket.emit('leave', evt.uid);

					stream.stop();
					document.querySelector("#video-container .right-part").removeChild(document.querySelector('#agora_container' + +evt.uid + ''));
					console.log(evt.uid + " leaved from this channel");
				});
			}
		});
	}

	join();

	function leave() {
		document.getElementById("leave").disabled = true;
		client.leave(function() {
			console.log("Leavel channel successfully");
		}, function(err) {
			console.log("Leave channel failed");
		});
	}

	function publish() {
		document.getElementById("publish").disabled = true;
		client.publish(localStream, function(err) {
			console.log("Publish local stream error: " + err);
		});
	}

	function unpublish() {
		document.getElementById("publish").disabled = false;
		document.getElementById("unpublish").disabled = true;
		client.unpublish(localStream, function(err) {
			console.log("Unpublish local stream failed" + err);
		});
	}

	function getDevices() {
		AgoraRTC.getDevices(function(devices) {
			for (var i = 0; i !== devices.length; ++i) {
				var device = devices[i];
				var option = document.createElement('option');
				option.value = device.deviceId;
				if (device.kind === 'audioinput') {
					option.text = device.label || 'microphone ' + (audioSelect.length + 1);
					audioSelect.appendChild(option);
				} else if (device.kind === 'videoinput') {
					option.text = device.label || 'camera ' + (videoSelect.length + 1);
					videoSelect.appendChild(option);
				} else {
					console.log('Some other kind of source/device: ', device);
				}
			}
		});
	}

	//audioSelect.onchange = getDevices;
	//videoSelect.onchange = getDevices;

	getDevices();
</script>
</body>
</html>
