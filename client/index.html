<!DOCTYPE html>
<html>
<head>
	<title>Agora Web Sample</title>
	<link rel="stylesheet" href="vendor/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">
	<script src="vendor/jquery.js"></script>
	<script src="vendor/socket.io.js"></script>
	<script src="vendor/adapter.js"></script>
	<script src="AgoraRTCSDK-1.2.5.js"></script>

	<script src="js/clmtrackr.js"></script>
	<script src="js/model_pca_20_svm.js"></script>
	<script src="js/model_pca_20_svm_emotionDetection.js"></script>
	<script src="js/Stats.js"></script>
	<script src="js/d3.min.js"></script>
	<script src="js/emotion_classifier.js"></script>
	<script src="js/emotionmodel.js"></script>
</head>

<body>
<div id="div_device" class="panel panel-default" style="display:none">
	<div class="select">
		<label for="audioSource">Audio source: </label><select id="audioSource"></select>
	</div>
	<div class="select">
		<label for="videoSource">Video source: </label><select id="videoSource"></select>
	</div>
</div>

<div id="div_join" class="panel panel-default" style="display:none">
	<div class="panel-body">
		<button id="join" class="btn btn-primary" onclick="join()">Join</button>
		<button id="leave" class="btn btn-primary" onclick="leave()">Leave</button>
		<button id="publish" class="btn btn-primary" onclick="publish()">Publish</button>
		<button id="unpublish" class="btn btn-primary" onclick="unpublish()">Unpublish</button>
	</div>
</div>

<div id="video-container">
	<div class="left-part">
		<div id="agora_local" style="width:400px;height:300px;display:inline-block;"></div>
		<div id="controls">
				<input class="btn" type="button" value="wait, loading video & images" disabled="disabled" onclick="startVideo()" id="startbutton"></input>
				<select name="mask" id="selectmask">
					<option value="0">Average face</option>
					<option value="1">Terminator</option>
					<option value="2">Walter</option>
					<option value="3">Clooney</option>
					<option value="4">Bieber</option>
					<option value="5">Kim</option>
					<option value="6">Rihanna</option>
					<option value="7">Audrey Hepburn</option>
					<option value="8">Bill Murray</option>
					<option value="9">Sean Connery</option>
					<option value="10">Cage</option>
					<option value="11">The Queen</option>
					<option value="12">Obama</option>
					<option value="13">Chuck Norris</option>
					<option value="14">Mona Lisa</option>
					<option value="15">Picasso</option>
					<option value="16">Abstract (Scream)</option>
				</select>
			</div>
	</div><div class="right-part"></div>
</div>

<script language="javascript">
	var client, localStream, camera, microphone;

	var socket = io();

	var channelValue = '1001';

	var audioSelect = document.querySelector('select#audioSource');
	var videoSelect = document.querySelector('select#videoSource');

	function join() {
		document.getElementById("join").disabled = true;
		document.getElementById("publish").disabled = true;
		// for dynamic key
		var dynamic_key;
		console.log("Try to get dynamic key");
		var use_https = ('https:' == document.location.protocol);
		if (use_https) {
			var url_str = "https://192.168.0.65:8443/dynamic_key?channelName=" + channelValue;
		} else {
			var url_str = "http://localhost:8080/dynamic_key?channelName=" + channelValue;
		}

		$.ajax({
			url: url_str,
			error: function() {
				console.log("Failed to get dynamic key");
			},
			success: function(response) {
				console.log(response.key);
				dynamic_key = response.key;

				client = AgoraRTC.createRtcClient();
				// for dynamic key
				client.init(dynamic_key, function() {
					console.log("AgoraRTC client initialized");
					client.join(channelValue, undefined, function(uid) {
						socket.emit('join', uid);

						console.log("User " + uid + " join channel successfully");

						camera = videoSource.value;

						microphone = audioSource.value;
						localStream = AgoraRTC.createStream({
							streamID: uid,
							audio: true,
							cameraId: camera,
							microphoneId: microphone,
							video: true,
							screen: false
						});

						localStream.setVideoProfile('480p_2');

						localStream.init(function() {
							console.log("getUserMedia successfully");
							localStream.play('agora_local');

							var subsCanvas = document.createElement('canvas');
							subsCanvas.id = 'webgl';
							subsCanvas.width = 405;
							subsCanvas.height = 303;
							document.querySelector('#agora_local').appendChild(subsCanvas);
							/*********** Code for face substitution *********/

							var animationRequest;
							var positions;
							document.getElementById('selectmask').addEventListener('change', updateMask, false);

							function updateMask(el) {
								currentMask = parseInt(el.target.value, 10);
								var positions = ctrack.getCurrentPosition(vid);
								if (positions) {
									switchMasks(positions);
								}
							}

							function startVideo() {
								// start video
								vid.play();
								// start tracking
								ctrack.start(vid);
								// start drawing face grid
								drawGridLoop();
							}

							var fd = new faceDeformer();
							fd.init(document.getElementById('webgl'));
							var wc1 = document.getElementById('webgl').getContext('webgl') || document.getElementById('webgl').getContext('experimental-webgl')
							wc1.clearColor(0,0,0,0);

							var fd2 = new faceDeformer();
							fd2.init(document.getElementById('webgl2'));
							var wc2 = document.getElementById('webgl2').getContext('webgl') || document.getElementById('webgl2').getContext('experimental-webgl')
							wc2.clearColor(0,0,0,0);

							var masks = {
												"average" : [[26.416248681267973, 69.287261104729708], [24.481184011083002, 109.1589911732479], [29.947934496257105, 148.57677024306452], [40.60811914491601, 185.45355598250219], [58.738097832656997, 216.6373204614957], [81.913770252207783, 237.8126294428132], [109.98606755351314, 257.32753166261085], [146.73017889094805, 264.20702756677571], [176.39901111159972, 257.35535351543069], [205.55603543434725, 238.34973455076488], [230.2355979713912, 210.41080746713624], [246.42195156813636, 177.61588628182037], [256.27933737115922, 136.43585286772219], [257.59862842161016, 101.26962757170907], [254.73574762861881, 63.296736154716768], [231.99351427704215, 39.831219799322724], [211.74886735135794, 29.357561061634286], [185.76946624427666, 32.692120457915841], [164.22794828410485, 39.057255405015212], [46.913242738637145, 44.216922272932521], [67.285057768685547, 32.598869110365555], [94.508786161963428, 34.746232646423401], [114.82786184548833, 39.533999746268229], [65.935953298843103, 69.239210402794683], [84.787589310043472, 58.321913189471772], [107.1385272571674, 69.051184056088701], [84.265668561805413, 74.447322016970119], [86.02844527485162, 66.55652441349649], [215.49276321482714, 66.02198446506911], [194.41225043477402, 56.580567518322354], [173.10349613934835, 67.506651798297085], [193.89655333472706, 70.825843235112714], [194.97190332017632, 64.213669799586413], [140.21544525228168, 50.532541524375866], [115.12210668936649, 112.86816444161286], [106.91733219119472, 128.11159519340237], [116.15332322527513, 140.65598165170533], [143.55679637420633, 142.73810254422773], [167.66884888729888, 137.95626733353842], [177.01070972200523, 125.94118566337217], [167.72534960722709, 111.07005102224311], [141.09391638922847, 89.711267100602939], [125.01121871692496, 134.01776882451776], [158.83114482022663, 132.84441173561655], [98.530013119819074, 181.49830160240677], [114.57531577249451, 172.88988327185314], [130.69321885263625, 168.51487947819879], [140.91575863744487, 170.62230018050224], [150.99524791299294, 168.10359663640762], [166.86355823591094, 171.92886610080987], [186.52748819945225, 179.57395522560827], [172.54811810821857, 193.62104452332397], [161.34374255744575, 203.55652478332667], [143.04951921782722, 206.98995295806665], [122.71362572694508, 202.88542194975037], [109.36831831524565, 194.44995485842813], [121.30529318118789, 187.44959256875671], [141.15688782807084, 190.12567632986739], [161.94486681509784, 187.9983882494468], [161.78346166803792, 178.31913412814549], [141.60005262336557, 178.73596022750081], [121.19014424606702, 179.74550271876572], [142.06000674291235, 125.94776468631429], [74.161858259749053, 61.982126979168953], [99.563603953011338, 61.887044688264439], [97.202478466508737, 72.650836394381287], [74.199064214851546, 73.344884154018885], [204.65317864223729, 59.203268807746532], [180.45823699179422, 60.544222235843449], [183.20168844348697, 70.667846856664895], [204.99820389502713, 70.525790218266522]]
											}

							var currentMask = 0;

										// canvas for copying the warped face to
										var newcanvas = document.createElement('CANVAS');
										newcanvas.width = vid.width;
										newcanvas.height = vid.height;
										// canvas for copying videoframes to
										var videocanvas = document.createElement('CANVAS');
										videocanvas.width = vid.width;
										videocanvas.height = vid.height;
										// canvas for masking
										var maskcanvas = document.createElement('CANVAS');
										maskcanvas.width = vid.width;
										maskcanvas.height = vid.height;

										// create canvases for all the faces
										var imageCanvases = {};
										var imageCount = 0;
										loadMask = function(index){
											var mask = new Image();
											mask.onload = function(obj){
												var elementId = images[index].id;

												// copy the images to canvases
												imagecanvas = document.createElement('CANVAS');
												imagecanvas.width = obj.target.width;
												imagecanvas.height = obj.target.height;
												imagecanvas.getContext('2d').drawImage(obj.target,0,0);
												imageCanvases[elementId] = imagecanvas;

												imageCount += 1;
												if (imageCount == images.length) {
													imagesReady = true;
												}
												enablestart();
											}
						              		mask.src = images[index].path;
										}
										//load masks
										for (var i = 0;i < images.length;i++) {
											loadMask(i);
										}

										var extended_vertices = [
										  [0,71,72,0],
										  [0,72,1,0],
										  [1,72,73,1],
										  [1,73,2,1],
										  [2,73,74,2],
										  [2,74,3,2],
										  [3,74,75,3],
										  [3,75,4,3],
										  [4,75,76,4],
										  [4,76,5,4],
										  [5,76,77,5],
										  [5,77,6,5],
										  [6,77,78,6],
										  [6,78,7,6],
										  [7,78,79,7],
										  [7,79,8,7],
										  [8,79,80,8],
										  [8,80,9,8],
										  [9,80,81,9],
										  [9,81,10,9],
										  [10,81,82,10],
										  [10,82,11,10],
										  [11,82,83,11],
										  [11,83,12,11],
										  [12,83,84,12],
										  [12,84,13,12],
										  [13,84,85,13],
										  [13,85,14,13],
										  [14,85,86,14],
										  [14,86,15,14],
										  [15,86,87,15],
										  [15,87,16,15],
										  [16,87,88,16],
										  [16,88,17,16],
										  [17,88,89,17],
										  [17,89,18,17],
										  [18,89,90,18],
										  [18,90,22,18],
										  [22,90,21,22],
										  [21,90,91,21],
										  [21,20,91,21],
										  [20,91,92,20],
										  [20,92,19,20],
										  [19,92,93,19],
										  [19,93,71,19],
										  [19,0,71,19],
										  [44,61,56,44],
										  [60,61,56,60],
										  [60,56,57,60],
										  [60,59,57,60],
										  [58,59,57,58],
										  [58,59,50,58]
										];

										function drawGridLoop() {
											// get position of face
											positions = ctrack.getCurrentPosition(vid);

											overlayCC.clearRect(0, 0, 500, 375);
											if (positions) {
												// draw current grid
												ctrack.draw(overlay);
											}
											// check whether mask has converged
											var pn = ctrack.getConvergence();
											if (pn < 0.4) {
												switchMasks(positions);
											} else {
												requestAnimFrame(drawGridLoop);
											}
										}

										function switchMasks(pos) {
											videocanvas.getContext('2d').drawImage(vid,0,0,videocanvas.width,videocanvas.height);

											// we need to extend the positions with new estimated points in order to get pixels immediately outside mask
											var newMaskPos = masks[images[currentMask].id].slice(0);
											var newFacePos = pos.slice(0);
											var extInd = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,22,21,20,19];
											var newp;
											for (var i = 0;i < 23;i++) {
												newp = [];
												newp[0] = (newMaskPos[extInd[i]][0]*1.3) - (newMaskPos[62][0]*0.3);// short for ((newMaskPos[extInd[i]][0]-newMaskPos[62][0])*1.1)+newMaskPos[62][0]
												newp[1] = (newMaskPos[extInd[i]][1]*1.3) - (newMaskPos[62][1]*0.3);
												newMaskPos.push(newp);
												newp = [];
												newp[0] = (newFacePos[extInd[i]][0]*1.3) - (newFacePos[62][0]*0.3);
												newp[1] = (newFacePos[extInd[i]][1]*1.3) - (newFacePos[62][1]*0.3);
												newFacePos.push(newp);
											}
											// also need to make new vertices incorporating area outside mask
											var newVertices = pModel.path.vertices.concat(extended_vertices);

											// deform the mask we want to use to face form
											fd2.load(imageCanvases[images[currentMask].id], newMaskPos, pModel, newVertices);
											fd2.draw(newFacePos);
											// and copy onto new canvas
											newcanvas.getContext('2d').drawImage(document.getElementById('webgl2'),0,0);

											// create masking
											var tempcoords = positions.slice(0,18);
											tempcoords.push(positions[21]);
											tempcoords.push(positions[20]);
											tempcoords.push(positions[19]);
											createMasking(maskcanvas, tempcoords);
											// do poisson blending
											Poisson.load(newcanvas, videocanvas, maskcanvas, function() {
												var result = Poisson.blend(30, 0, 0);
												// render to canvas
												newcanvas.getContext('2d').putImageData(result, 0, 0);
												// get mask

												var maskname = Object.keys(masks)[currentMask];
												fd.load(newcanvas, pos, pModel);
												requestAnimFrame(drawMaskLoop);
											});
										}

										function drawMaskLoop() {
											// get position of face
											positions = ctrack.getCurrentPosition();

											/*for (var i = 0;i < positions.length;i++) {
												positions[i][1] += 1;
											}*/

											overlayCC.clearRect(0, 0, 400, 300);
											if (positions) {
												// draw mask on top of face
												fd.draw(positions);
											}
											animationRequest = requestAnimFrame(drawMaskLoop);
										}

										function createMasking(canvas, modelpoints) {
											// fill canvas with black
											var cc = canvas.getContext('2d');
											cc.fillStyle="#000000";
											cc.fillRect(0,0,canvas.width, canvas.height);
											cc.beginPath();
											cc.moveTo(modelpoints[0][0], modelpoints[0][1]);
											for (var i = 1;i < modelpoints.length;i++) {
												cc.lineTo(modelpoints[i][0], modelpoints[i][1]);
											}
											cc.lineTo(modelpoints[0][0], modelpoints[0][1]);
											cc.closePath();
											cc.fillStyle="#ffffff";
											cc.fill();
										}





							client.publish(localStream, function(err) {
								console.log("Publish local stream error: " + err);
							});

							client.on('stream-published', function(evt) {
								console.log("Publish local stream successfully");
							});

						}, function(err) {
							console.log("getUserMedia failed", err);
						});

					}, function(err) {
						console.log("Join channel failed", err);
					});

				}, function(err) {
					console.log("AgoraRTC client init failed", err);
				});

				client.on('stream-added', function(evt) {
					var stream = evt.stream;
					console.log("New stream added: " + stream.getId());
					console.log("Subscribe ", stream);
					client.subscribe(stream, function(err) {
						console.log("Subscribe stream failed", err);
					});
				});

				client.on('stream-subscribed', function(evt) {
					var stream = evt.stream;
					console.log("Subscribe remote stream successfully: " + stream.getId());
					if ($('div#video-container #agora_remote' + stream.getId()).length === 0) {
						var container = document.createElement("div");
						container.id = 'agora_container' + stream.getId();
						document.querySelector('#video-container .right-part').appendChild(container);
						$(container).append('<div id="agora_remote' + stream.getId() + '" style="width:405px;height:303px;display:inline-block;"></div>');
						$(container).append('<canvas id="drawCanvas' + stream.getId() + '" width='+405+' height='+303+'"></canvas>');
						$(container).append('<div id="emotion_container"> <div id="emotion_icons"> <img class="emotion_icon" id="icon1" src="./media/icon_angry.png"> <img class="emotion_icon" id="icon2" src="./media/icon_sad.png"> <img class="emotion_icon" id="icon3" src="./media/icon_surprised.png"> <img class="emotion_icon" id="icon4" src="./media/icon_happy.png"> </div> <div id="emotion_chart"></div>')};
						stream.play('agora_remote' + stream.getId());

						var canvasInput = document.querySelector('#drawCanvas' + + stream.getId() +'');
						var videoInput = document.querySelector('#agora_remote' + + stream.getId() + ' video');
						videoInput.width = 400;
						videoInput.height = 300;

						var ctracker = new clm.tracker();
						ctracker.init(pModel);
						ctracker.start(videoInput);

					function positionLoop() {
						requestAnimationFrame(positionLoop);
						var positions = ctracker.getCurrentPosition();
						// positions = [[x_0, y_0], [x_1,y_1], ... ]
						// do something with the positions ...
					}
					positionLoop();

					var cc = canvasInput.getContext('2d');
					function drawLoop() {
						requestAnimationFrame(drawLoop);
						cc.clearRect(0, 0, canvasInput.width, canvasInput.height);
						if (ctracker.getCurrentPosition()) {
						ctracker.draw(canvasInput);
						}
						var cp = ctracker.getCurrentParameters();

						var er = ec.meanPredict(cp);
						if (er) {
							updateData(er);
							for (var i = 0;i < er.length;i++) {
								if (er[i].value > 0.4) {
									document.getElementById('icon'+(i+1)).style.visibility = 'visible';
								} else {
									document.getElementById('icon'+(i+1)).style.visibility = 'hidden';
								}
							}
						}
					}

// *******************************d3 code

var ec = new emotionClassifier();
				ec.init(emotionModel);
				var emotionData = ec.getBlank();

				/************ d3 code for barchart *****************/

				var margin = {top : 20, right : 20, bottom : 10, left : 40},
					width = 400 - margin.left - margin.right,
					height = 100 - margin.top - margin.bottom;

				var barWidth = 30;

				var formatPercent = d3.format(".0%");

				var x = d3.scale.linear()
					.domain([0, ec.getEmotions().length]).range([margin.left, width+margin.left]);

				var y = d3.scale.linear()
					.domain([0,1]).range([0, height]);

				var svg = d3.select("#emotion_chart").append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)

				svg.selectAll("rect").
				  data(emotionData).
				  enter().
				  append("svg:rect").
				  attr("x", function(datum, index) { return x(index); }).
				  attr("y", function(datum) { return height - y(datum.value); }).
				  attr("height", function(datum) { return y(datum.value); }).
				  attr("width", barWidth).
				  attr("fill", "#2d578b");

				svg.selectAll("text.labels").
				  data(emotionData).
				  enter().
				  append("svg:text").
				  attr("x", function(datum, index) { return x(index) + barWidth; }).
				  attr("y", function(datum) { return height - y(datum.value); }).
				  attr("dx", -barWidth/2).
				  attr("dy", "1.2em").
				  attr("text-anchor", "middle").
				  text(function(datum) { return datum.value;}).
				  attr("fill", "white").
				  attr("class", "labels");

				svg.selectAll("text.yAxis").
				  data(emotionData).
				  enter().append("svg:text").
				  attr("x", function(datum, index) { return x(index) + barWidth; }).
				  attr("y", height).
				  attr("dx", -barWidth/2).
				  attr("text-anchor", "middle").
				  attr("style", "font-size: 12").
				  text(function(datum) { return datum.emotion;}).
				  attr("transform", "translate(0, 18)").
				  attr("class", "yAxis");

				function updateData(data) {
					// update
					var rects = svg.selectAll("rect")
						.data(data)
						.attr("y", function(datum) { return height - y(datum.value); })
						.attr("height", function(datum) { return y(datum.value); });
					var texts = svg.selectAll("text.labels")
						.data(data)
						.attr("y", function(datum) { return height - y(datum.value); })
						.text(function(datum) { return datum.value.toFixed(1);});

					// enter
					rects.enter().append("svg:rect");
					texts.enter().append("svg:text");

					// exit
					rects.exit().remove();
					texts.exit().remove();
				}

				// end of d3 code *******************



					drawLoop();
				});

				client.on('stream-removed', function(evt) {
					var stream = evt.stream;
					stream.stop();
					console.log("Remote stream is removed " + stream.getId());
				});

				client.on('peer-leave', function(evt) {
					var stream = evt.stream;

					socket.emit('leave', evt.uid);

					stream.stop();
					document.querySelector("#video-container").removeChild(document.querySelector('#agora_container' + + evt.uid + ''));
					console.log(evt.uid + " leaved from this channel");
				});
			}
		});
	}

	join();

	function leave() {
		document.getElementById("leave").disabled = true;
		client.leave(function() {
			console.log("Leavel channel successfully");
		}, function(err) {
			console.log("Leave channel failed");
		});
	}

	function publish() {
		document.getElementById("publish").disabled = true;
		client.publish(localStream, function(err) {
			console.log("Publish local stream error: " + err);
		});
	}

	function unpublish() {
		document.getElementById("publish").disabled = false;
		document.getElementById("unpublish").disabled = true;
		client.unpublish(localStream, function(err) {
			console.log("Unpublish local stream failed" + err);
		});
	}

	function getDevices() {
		AgoraRTC.getDevices(function(devices) {
			for (var i = 0; i !== devices.length; ++i) {
				var device = devices[i];
				var option = document.createElement('option');
				option.value = device.deviceId;
				if (device.kind === 'audioinput') {
					option.text = device.label || 'microphone ' + (audioSelect.length + 1);
					audioSelect.appendChild(option);
				} else if (device.kind === 'videoinput') {
					option.text = device.label || 'camera ' + (videoSelect.length + 1);
					videoSelect.appendChild(option);
				} else {
					console.log('Some other kind of source/device: ', device);
				}
			}
		});
	}

	//audioSelect.onchange = getDevices;
	//videoSelect.onchange = getDevices;

	getDevices();
</script>
</body>
</html>
